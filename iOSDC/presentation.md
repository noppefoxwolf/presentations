footer: ðŸ¦Š @noppefoxwolf, 2018
slidenumbers: true

> ãƒ©ã‚¤ãƒ–é…ä¿¡ã‚¢ãƒ—ãƒªã®ã‚¢ã‚¤ãƒ†ãƒ å†ç”Ÿã‚’Metalã§å®Ÿè£…ã™ã‚‹äº‹ã«ãªã£ãŸè©±
-- iOSDC Japan Track B 2018/09/02 11:20ã€œ

---

#[fit] noppe

ðŸ“± iOSã‚¢ãƒ—ãƒªé–‹ç™º8å¹´ç›®
ðŸ¦Š ãã¤ã­å¥½ã
ðŸ‘¨ðŸ»â€ðŸ’» æ ªå¼ä¼šç¤¾ãƒ‡ã‚£ãƒ¼ãƒ»ã‚¨ãƒŒãƒ»ã‚¨ãƒ¼

![right](IMG_0726.PNG)

^ è‡ªå·±ç´¹ä»‹

---

//å‡ºã—ãŸã‚‚ã®ã‚ã‚Œã°

---

ä»Šæ—¥ã®è©±
ãƒ»
ãƒ»
ãƒ»
# æœ¬ãƒˆãƒ¼ã‚¯ã«ã¤ã„ã¦
è‡ªåˆ†ã¯Metalåˆå¿ƒè€…
è‡ªåˆ†ã¯OpenGLESåˆå¿ƒè€…
OpenGLã‚„Metalã‚’å­¦ã¶ç‚ºã«æ‰‹é ƒãªä¾‹ã‚’è¦‹ã¤ã‘ãŸã®ã§ç´¹ä»‹
è©±ã®å‰²åˆã¯ã€ã‚µãƒ¼ãƒ“ã‚¹èª²é¡Œã®å¯¾å¿œãŒåŠåˆ†ã€MetalåŠåˆ†
ãƒ©ã‚¤ãƒ–é…ä¿¡è‡ªä½“ã«ã¤ã„ã¦ã¯ã—ã¾ã›ã‚“
å¾ŒåŠã¯OpenGLES/Metalã«å…¥é–€ã—ãŸæ™‚ã®è©±


---

# ã‚µãƒ¼ãƒ“ã‚¹ã®ç´¹ä»‹
ãƒ©ã‚¤ãƒ–é…ä¿¡çŸ¥ã£ã¦ã¾ã™ã‹
ãƒ©ã‚¤ãƒ–é…ä¿¡ã‚µãƒ¼ãƒ“ã‚¹ã®æœ€è¿‘ã®å‹•å‘
é…ä¿¡ã™ã‚‹ã ã‘ã§ã¯ãªãã€ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½¿ã£ã¦é…ä¿¡ã‚’ç››ã‚Šä¸Šã’ã‚‹æµã‚Œã«
ã‚¢ã‚¤ãƒ†ãƒ ã®æ´¾æ‰‹ã•ã‚„æ¥½ã—ã•ãŒå·®åˆ¥è¦ç´ ã«
DeNAã§è‡ªåˆ†ã¯Pocochaã¨ã„ã†ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚„ã£ã¦ã„ã‚‹
ã©ã‚“ãªã‚‚ã®ãªã®ã‹

---

å…·ä½“çš„ã«ã‚¤ãƒ¡ãƒ¼ã‚¸ã—ã¦ã‚‚ã‚‰ã†ãŸã‚ã«å‹•ç”»
Pocochaã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¦‹ã¦æ¬²ã—ã„
[å‹•ç”»]
ã“ã‚Œã‚’ã©ã®ã‚ˆã†ã«å®Ÿè£…ã—ãŸã‹ã‚’é †ã‚’è¿½ã£ã¦è§£èª¬

---

# è¦ä»¶ã®ç¢ºèª
ã©ã‚“ãªæ‰‹æ³•ãŒã‚ã‚‹ã‹
ãƒ»å‹•ç”»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é‡ã­ã‚‹
ãƒ»æç”»
ãƒ»æ˜ åƒã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã«æ··ãœã¡ã‚ƒã†ã¨ã‹
ãƒ»é…ä¿¡ã‚’ã—ãªãŒã‚‰ãªã®ã§ã€ä½Žç‡ƒè²»ã«å‹•ä½œã™ã‚‹å¿…è¦ãŒã‚ã‚‹

ã‚¢ã‚¤ãƒ†ãƒ å†ç”Ÿï¼ç”»é¢å…¨ä½“ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹
//å‹•ç”»ã®ä»•æ§˜
750â€†Ã—â€†1334 60fps
å®Ÿéš›ã¯ã‚‚ã†å°‘ã—ä½Žã„ãŒæ¯”è¼ƒã®ãŸã‚ã«ã“ã®ã‚¹ãƒšãƒƒã‚¯

ä¸€ç•ªæœ€åˆã«å®Ÿè£…ã—ãŸã®ã¯UIImageViewã®animateImages
ffmpeg -i M_sea30fps.mov M_sea30fps/output_%04d.png

du -h
288M    ./M_sea60fps

animateImagesãŒæ‚ªã„ï¼Ÿï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¿ã‚‹
movã‚’é€£ç•ªpngã«å¤‰æ›ã—ã¾ã™
å†ç”Ÿ
[å‹•ç”»]
ãƒ€ãƒ¡ã§ã—ãŸã€‚
animateImagesã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãƒ¡ãƒ¢ãƒªãŒç¢ºä¿ã•ã‚Œã‚‹ï¼Ÿ
//å§‹ã¾ã‚‹ã¾ã§é…ã„
    //ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã¨fps
    //ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã ã¨æ„å¤–ã¨å‹•ã...
    //ãã‚‚ãã‚‚ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã®å®¹é‡


//ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹æ¸¬å®š
æç”»å‘¨ã‚Šã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹è¨ˆæ¸¬ã¯éžå¸¸ã«é›£ã—ã„
Instrumentãªã©ãŒã‚ã‚‹ãŒâ€¦
ç›®ã§è¦‹ã¦ã‚„ã‚‹ã®ãŒè‰¯ã„
å®Ÿéš›ã®ç’°å¢ƒã§è¡Œã†ã®ãŒè‰¯ã„
å¤ã„ç«¯æœ«ã€å¤ã„OSã§ã‚„ã‚ã†
ä»Šå›žã¯5s
æœ€åˆã¯ã“ã†ã—ã¦ã„ãŸ
ã“ã†ã„ã†å®Ÿè£…ã®ã‚¢ãƒ—ãƒªã‚‚ã‚ã‚‹ã‚“ã˜ã‚ƒãªã„ã§ã—ã‚‡ã†ã‹

æ¬¡ã«æ¯Žãƒ•ãƒ¬ãƒ¼ãƒ imageã‚’åˆ‡ã‚Šæ›¿ãˆã¦ã„ã
ã“ã‚Œã¯ã©ã†ã‹ãª

ã“ã“ã¾ã§ã§äºŒã¤ã®å•é¡Œ
ãƒ»å®¹é‡ã®å•é¡Œ
ãƒ»æç”»ã®å•é¡Œ

# å®¹é‡ã®å•é¡Œ
åœ§ç¸®ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ç”»åƒã«æœ€é©ãªãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ=å‹•ç”»
å‹•ç”»ã‹ã‚‰æ¯Žãƒ•ãƒ¬ãƒ¼ãƒ ç”»åƒã‚’å–ã‚Šå‡ºã›ã°ã€ã‚µã‚¤ã‚ºã¯è»½ã„ã¾ã¾ãƒãƒ³ãƒ‰ãƒ«ã§ãã‚‹
GIF/APNG/WEBP/MP4/MOV
é€éŽã§ãã‚‹ã‹ã€ä»•çµ„ã¿ã€å…¬å¼ã«å¯¾å¿œã—ã¦ã„ã‚‹ã‹ã€ãƒ‡ã‚³ãƒ¼ãƒ‰è² è·ã€å®¹é‡ã€è¡¨ç¾åŠ›

- PNG/JPG
ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚µãƒãƒ¼ãƒˆ

- GIF
https://github.com/kirualex/SwiftyGif
GIFã‚’1ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã«UIImageã«å¤‰æ›ã—ã¦ã€ç‹¬è‡ªã®ãƒ«ãƒ¼ãƒ—ã®ä¸­ã§UIImageView.imageã‚’å·®ã—æ›¿ãˆã¦ã„ã‚‹
ä¸€èˆ¬çš„ãªéžå¯¾å¿œãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã®å¯¾å¿œã®ä»•æ–¹
æ™®é€šã¯UIImageViewã‚’ä½¿ã†ã®ã§ä½¿ã„å‹æ‰‹ãŒè‰¯ã„

- APNG
https://github.com/onevcat/APNGKit
libpng
APNGImageView: UIView
ä¸€åº¦UIImageã«å¤‰æ›ã—ã¦ã‹ã‚‰CGImageã‚’layer.contentsã«è¨­å®š
ã“ã‚Œã¯UIImageViewã¨åŒã˜ä»•çµ„ã¿

- WEBP
libWEBP

- MP4
h264
é€éŽæƒ…å ±æŒã¦ãªã„
ãƒ‡ãƒ•ã‚©ã§å¯¾å¿œ

- MOV
é€éŽæƒ…å ±ãŒæŒã¦ã‚‹

å¯¾å¿œã—ã¦ã„ã‚‹ã‚‚ã®ã‚‚å¯¾å¿œã—ã¦ã„ãªã„ã‚‚ã®ã‚‚åŸºæœ¬ã¯åŒã˜
ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰â†’ãƒ”ã‚¯ã‚»ãƒ«å˜ä½ã®è‰²æƒ…å ±â†’æç”»
ãƒ‡ã‚³ãƒ¼ãƒ‰å‡¦ç†ã¯CPUã§è¡Œã‚ã‚Œã‚‹
https://developer.apple.com/videos/play/wwdc2018/219/
https://github.com/koher/EasyImagy
å®¹é‡ã¨ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã«ãƒ‡ã‚³ãƒ¼ãƒ‰
drawinrectä½¿ã†ã¨æœ€é©åŒ–ã®æ©æµãŒå—ã‘ã‚‰ã‚Œãªã„

# iOSã§ã¯å†ç”Ÿã§ããªã„è©±
movãŒä¸€ç•ªè‰¯ã•ãã†ã€‚
å†ç”Ÿã—ã¦ã¿ã‚‹ã€iOSã§ã¯ã§ããªã„ã€‚

é€éŽå‡ºæ¥ã‚‹ã®ãŒè‰¯ã•ãã†ã ã‘ã©â€¦
ãã‚‚ãã‚‚ãƒ‡ã‚³ãƒ¼ãƒ‰ã¯æ¯Žãƒ•ãƒ¬ãƒ¼ãƒ ç”»åƒä½œã£ã¦ã„ã‚‹
å®¹é‡ã¨ç”»è³ªã®ãƒãƒ©ãƒ³ã‚¹ãŒè‰¯ã„ã‚‚ã®ã‚’é¸ã‚“ã§å¾Œã‹ã‚‰é€éŽã™ã‚Œã°ã„ã„
ã©ã†ã™ã‚Œã°é€éŽå‡ºæ¥ã‚‹ã®ã‹
ä»Šå›žã¯mp4ã‚’é¸ã‚“ã 
ãƒ»ãƒ‡ã‚³ãƒ¼ãƒ€ãŒå…¬å¼æä¾›ã•ã‚Œã¦ã„ã‚‹


# é€éŽå‹•ç”»ã®å†ç”Ÿæ‰‹æ³•ã®ç´¹ä»‹
alpha maskã‚’è¡Œã† CIFilter
äºŒã¤ã®mp4ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ãªãŒã‚‰ãƒžã‚¹ã‚¯
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§FilterãŒã‚ã‚‹

UIImageView.imageã¸æç”»

MP4 -> SampleBuffer -> CIImage -> CIFilter -> UIImage -> æç”»ï¼ˆUIImageViewï¼‰
é‡ã„
ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒå¤§ãã„
CIImageã¯ãƒ¬ã‚·ãƒ”ã®ã‚ˆã†ãªã‚‚ã®ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã¯ç„¡ã„
ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§åˆã‚ã¦å‡¦ç†ãŒèµ°ã‚‹
CIFilterã®outputã‚’å¾…ã£ã¦ã‹ã‚‰ã«ãªã£ã¦ã—ã¾ã†
CIIMahgeã¯å®Ÿæ…‹ã‚’æŒãŸãªã„ã€UIImageViewã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§GPUã«ã‚ˆã£ã¦å‡¦ç†ã•ã‚Œã‚‹

MP4 -> SampleBuffer -> CIImage -> CIFilter -> UIImage -> æç”»ï¼ˆEAGLViewï¼‰
å¤‰ã‚ã‚‰ãªã„ï¼Ÿ
ã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ã¨ã¯
UIImageViewã¯ååˆ†ã«é«˜é€Ÿã€OpenGLESã‚’ç›´æŽ¥ä½¿ã†æ„å‘³ã¯ï¼Ÿ
ã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ã‚’ä½¿ã†ã“ã¨ã«æ„å‘³ãŒã‚ã‚‹


MP4 -> SampleBuffer -> CIImage -> ã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ã§æç”»ï¼ˆEAGLViewï¼‰
æ—©ããªã£ãŸï¼ã“ã‚Œã§è‰¯ã„ã˜ã‚ƒã‚“ï¼
Kitsunebi

OpenGLES deplicated!!

MP4 -> SampleBuffer -> CIImage -> ã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ã§æç”»ï¼ˆMTLViewï¼‰
OpenGLESã®ã‚·ã‚§ãƒ¼ãƒ€ã‹ã‚‰æ›¸ãç›´ã™
æ—©ããªã£ãŸã€å¤§ãã„ãƒ†ã‚¯ã‚¹ãƒãƒ£ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚
ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒå°‘ãªã„ã‚‰ã—ã„
Kitsunebi_Metal

ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ“ãƒ«ãƒ‰å‡ºæ¥ãªã„ã®ã§æ³¨æ„
å¯¾å¿œOSã«ã‚ˆã£ã¦ã¯è¾›ã„

ã“ã‚Œã¯ã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ã‚’ä½¿ã£ãŸMetalã®è‰¯ã„ã‚µãƒ³ãƒ—ãƒ«ã«ãªã‚‹ã‹ã‚‚ã—ã‚Œãªã„

# ã¾ã åŠ¹çŽ‡åŒ–ã§ãã‚‹ç®‡æ‰€ã¯ã‚ã‚Šã¾ã™
AVAssetReader -> ä½Žãƒ¬ã‚¤ãƒ¤ãƒ¼ã§å®Ÿè£…ã—ã¦ã¿ã‚ˆã†
ã‚ªãƒ¬ã‚ªãƒ¬AVPlayer
ä¿ºã‚³ãƒ³ã€æŠ€è¡“æ›¸å±•ã§ç™ºè¡¨

---
ã‚ã‚‚

DeNAã®ãƒ©ã‚¤ãƒ–é…ä¿¡ã‚¢ãƒ—ãƒªPocochaã§å®Ÿè£…ã—ãŸç”»é¢å…¨ä½“ã«å†ç”Ÿã•ã‚Œã‚‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®å®Ÿè£…ã®è©±ã‚’ã—ã¾ã™ã€‚
iOSã§ã¯å†ç”Ÿå‡ºæ¥ãªã„é€éŽå‹•ç”»ã®å†ç”Ÿã‚’è¡Œã†å®Ÿè£…ã‚„ã€ãã‚Œã‚‰ã®å®Ÿè£…ã®ä¸­ã§åˆ©ç”¨ã—ãŸå·¨å¤§ãªã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç”»åƒç¾¤ã®å†ç”Ÿã«æœ€é©ãªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’APNG/WEBPãªã©ã®ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã‚„UIImageView/OpenGLES/Metalãªã©ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹æ¯”è¼ƒã‹ã‚‰èª­ã¿è§£ãã¾ã™ã€‚

70æžšå‰å¾Œã«ã—ãŸã„


CPU/GPUã®ãƒ¡ãƒ¢ãƒªã¯åŒã˜å ´æ‰€ã«ã‚ã‚‹ãŒã€OpenGLESã§ã¯å…±æœ‰ã•ã‚Œã¦ã„ãªã„
http://dsas.blog.klab.org/archives/52168462.html

https://developer.apple.com/documentation/metal/fundamental_lessons/cpu_and_gpu_synchronization

60fpsã®å¤§ãã‚ã®ã‚„ã¤ç”¨æ„å‡ºæ¥ã‚‹ã‹

Metalãƒ•ã‚¡ãƒŸãƒªãƒ¼

mov -> mp4 alpha
ffmpeg -i sample.mov -vf alphaextract,format=yuv420p output.mov

mov -> é€£ç•ªpng